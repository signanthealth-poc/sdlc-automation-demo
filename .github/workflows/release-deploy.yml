name: ğŸš€ SDLC - Release & Deploy Pipeline

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

permissions:
  contents: write
  packages: write
  deployments: write

env:
  NODE_VERSION: '18'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Phase 1: Create Release
  create-release:
    name: ğŸ“¦ Create Release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    outputs:
      release-id: ${{ steps.create-release.outputs.id }}
      release-url: ${{ steps.create-release.outputs.html_url }}
    steps:
      - name: ğŸ”„ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“ Generate release notes
        id: release-notes
        run: |
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")
          if [ -n "$PREVIOUS_TAG" ]; then
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" $PREVIOUS_TAG..HEAD)
          else
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --max-count=10)
          fi
          
          cat << EOF > release_notes.md
          ## ğŸš€ What's New in ${GITHUB_REF_NAME}
          
          ### ğŸ“‹ Changes
          $CHANGELOG
          
          ### ğŸ”§ Technical Details
          - **Build Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          - **Commit:** ${GITHUB_SHA:0:7}
          - **Branch:** ${GITHUB_REF_NAME}
          
          ### ğŸ“¦ Artifacts
          - Docker Image: \`${REGISTRY}/${IMAGE_NAME}:${GITHUB_REF_NAME}\`
          - Source Code: Available in this release
          
          ### ğŸ—ï¸ Deployment
          This release can be deployed to staging and production environments using the deployment workflows.
          EOF

      - name: ğŸ·ï¸ Create GitHub Release
        id: create-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PRERELEASE=""
          if [[ "${{ github.ref_name }}" == *"beta"* ]] || [[ "${{ github.ref_name }}" == *"alpha"* ]] || [[ "${{ github.ref_name }}" == *"rc"* ]]; then
            PRERELEASE="--prerelease"
          fi
          
          gh release create "${{ github.ref_name }}" \
            --title "Release ${{ github.ref_name }}" \
            --notes-file release_notes.md \
            $PRERELEASE

  # Phase 2: Deploy to Staging
  deploy-staging:
    name: ğŸ­ Deploy to Staging
    runs-on: ubuntu-latest
    needs: create-release
    if: always() && (startsWith(github.ref, 'refs/tags/') || github.event.inputs.environment == 'staging')
    environment:
      name: staging
      url: https://staging.sdlc-demo.example.com
    steps:
      - name: ğŸ”„ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ­ Deploy to Staging Environment
        run: |
          echo "ğŸš€ Deploying to staging environment..."
          echo "ğŸ“¦ Using image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.ref_name || 'latest' }}"
          
          # Simulate deployment steps
          echo "1. â¬‡ï¸  Pulling latest image..."
          sleep 2
          echo "2. ğŸ”„ Updating configuration..."
          sleep 2
          echo "3. ğŸ”„ Rolling out new version..."
          sleep 3
          echo "4. âœ… Health check passed"
          sleep 1
          echo "5. ğŸ“ Updating load balancer..."
          sleep 2
          echo "âœ… Deployment to staging completed successfully!"

      - name: ğŸ§ª Run smoke tests
        run: |
          echo "ğŸ§ª Running smoke tests against staging..."
          # Simulate smoke tests
          curl -f https://staging.sdlc-demo.example.com/health || echo "Health check: âœ…"
          curl -f https://staging.sdlc-demo.example.com/api/status || echo "API status: âœ…"
          echo "âœ… All smoke tests passed!"

      - name: ğŸ“Š Update deployment status
        run: |
          echo "## ğŸ­ Staging Deployment" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** Staging" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ github.ref_name || 'latest' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** âœ… Deployed Successfully" >> $GITHUB_STEP_SUMMARY
          echo "- **URL:** https://staging.sdlc-demo.example.com" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed at:** $(date -u)" >> $GITHUB_STEP_SUMMARY

  # Phase 3: Deploy to Production
  deploy-production:
    name: ğŸ­ Deploy to Production
    runs-on: ubuntu-latest
    needs: [create-release, deploy-staging]
    if: always() && needs.deploy-staging.result == 'success' && (startsWith(github.ref, 'refs/tags/') || github.event.inputs.environment == 'production')
    environment:
      name: production
      url: https://sdlc-demo.example.com
    steps:
      - name: ğŸ”„ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ­ Deploy to Production Environment
        run: |
          echo "ğŸš€ Deploying to production environment..."
          echo "ğŸ“¦ Using image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.ref_name || 'latest' }}"
          
          # Simulate blue-green deployment
          echo "1. ğŸ”µ Setting up blue environment..."
          sleep 3
          echo "2. â¬‡ï¸  Pulling latest image to blue..."
          sleep 2
          echo "3. ğŸ”„ Starting blue environment..."
          sleep 3
          echo "4. ğŸ§ª Running health checks on blue..."
          sleep 2
          echo "5. ğŸ”„ Switching traffic to blue..."
          sleep 2
          echo "6. ğŸŸ¢ Blue is now live (green retired)"
          sleep 1
          echo "âœ… Production deployment completed successfully!"

      - name: ğŸ§ª Run production smoke tests
        run: |
          echo "ğŸ§ª Running smoke tests against production..."
          # Simulate production smoke tests
          curl -f https://sdlc-demo.example.com/health || echo "Health check: âœ…"
          curl -f https://sdlc-demo.example.com/api/status || echo "API status: âœ…"
          echo "âœ… All production smoke tests passed!"

      - name: ğŸ“Š Update deployment status
        run: |
          echo "## ğŸ­ Production Deployment" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** Production" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ github.ref_name || 'latest' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** âœ… Deployed Successfully" >> $GITHUB_STEP_SUMMARY
          echo "- **URL:** https://sdlc-demo.example.com" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed at:** $(date -u)" >> $GITHUB_STEP_SUMMARY

  # Phase 4: Post-Deployment Monitoring
  post-deploy-monitoring:
    name: ğŸ“Š Post-Deploy Monitoring
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production]
    if: always() && (needs.deploy-staging.result == 'success' || needs.deploy-production.result == 'success')
    steps:
      - name: ğŸ“Š Monitor application health
        run: |
          echo "ğŸ“Š Starting post-deployment monitoring..."
          
          # Simulate monitoring setup
          echo "1. ğŸ” Setting up health monitoring..."
          sleep 2
          echo "2. ğŸ“Š Configuring metrics collection..."
          sleep 2
          echo "3. ğŸš¨ Setting up alerting rules..."
          sleep 2
          echo "4. ğŸ“ˆ Dashboard updated with new deployment..."
          sleep 1
          echo "âœ… Monitoring setup completed!"

      - name: ğŸ“¢ Notify stakeholders
        run: |
          echo "ğŸ“¢ Notifying stakeholders of successful deployment..."
          
          # Create deployment notification
          cat << EOF >> $GITHUB_STEP_SUMMARY
          
          ## ğŸ‰ Deployment Notification
          
          ### ğŸ“¦ Release Information
          - **Version:** ${{ github.ref_name || 'latest' }}
          - **Commit:** ${{ github.sha }}
          - **Actor:** ${{ github.actor }}
          
          ### ğŸŒ Environments
          $(if [ "${{ needs.deploy-staging.result }}" = "success" ]; then echo "- âœ… **Staging:** https://staging.sdlc-demo.example.com"; fi)
          $(if [ "${{ needs.deploy-production.result }}" = "success" ]; then echo "- âœ… **Production:** https://sdlc-demo.example.com"; fi)
          
          ### ğŸ“Š Next Steps
          - Monitor application metrics and logs
          - Verify user experience
          - Check for any alerts or issues
          - Schedule post-deployment review
          EOF

  # Phase 5: Rollback (if needed)
  rollback:
    name: ğŸ”„ Rollback (Manual Trigger)
    runs-on: ubuntu-latest
    if: failure() && (needs.deploy-staging.result == 'failure' || needs.deploy-production.result == 'failure')
    needs: [deploy-staging, deploy-production]
    steps:
      - name: ğŸ”„ Rollback deployment
        run: |
          echo "ğŸš¨ Initiating rollback procedure..."
          
          # Simulate rollback
          echo "1. ğŸ” Identifying last known good version..."
          sleep 2
          echo "2. ğŸ”„ Rolling back to previous version..."
          sleep 3
          echo "3. ğŸ§ª Running health checks..."
          sleep 2
          echo "4. ğŸ“¢ Notifying team of rollback..."
          sleep 1
          echo "âœ… Rollback completed successfully!"

      - name: ğŸ“Š Update rollback status
        run: |
          echo "## ğŸ”„ Rollback Executed" >> $GITHUB_STEP_SUMMARY
          echo "- **Reason:** Deployment failure detected" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** âœ… Successfully rolled back" >> $GITHUB_STEP_SUMMARY
          echo "- **Time:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "- **Action Required:** Review logs and fix issues before next deployment" >> $GITHUB_STEP_SUMMARY